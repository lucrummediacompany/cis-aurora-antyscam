<!DOCTYPE html>
<html lang="pl">
<head>
  <!-- Outseta embed (auth + profile + nocode widgets) -->
  <script>
    var o_options = {
      domain: 'lucrum-media-company-spolka-z-ograniczona-odpowiedzialnoscia.outseta.com',
      load: 'auth,customForm,emailList,leadCapture,nocode,profile,support'
    };
  </script>
  <script src="https://cdn.outseta.com/outseta.min.js" data-options="o_options"></script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CIS Aurora ‚Äî AntyScam (Local)</title>

  <style>
    :root { color-scheme: dark; }
    body {
      font-family: Arial, sans-serif;
      margin: 32px;
      background: #0e0f13;
      color: #e6e7ea;
    }
    .wrap { max-width: 900px; margin: auto; }
    h1 { margin-bottom: 8px; }

    .card {
      border: 1px solid #2a2e37;
      border-radius: 12px;
      padding: 16px;
      margin-top: 16px;
      background: #141720;
      box-shadow: 0 2px 10px rgba(0,0,0,.4);
    }

    input[type=text]{
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #2a2e37;
      background: #0f1220;
      color: #e6e7ea;
    }

    button {
      padding: 10px 16px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      transition: all .2s ease-in-out;
    }
    button.primary { background: #1f2330; color: #e6e7ea; }
    button.primary:hover { background: #2b3242; }

    pre {
      white-space: pre-wrap;
      background: #0f1220;
      padding: 12px;
      border-radius: 8px;
      max-height: 480px;
      overflow: auto;
      color: #e6e7ea;
    }

    .muted { color: #9aa0a6; font-size: 14px; }
    .row { display: flex; gap: 8px; margin-top: 8px; }

    nav.row { margin-bottom: 12px; }
    nav.row a.button{
      text-decoration: none;
      background: #1f2330;
      color: #e6e7ea;
      padding: 8px 14px;
      border-radius: 8px;
      transition: background .2s;
    }
    nav.row a.button:hover { background: #2b3242; }

    /* Pasek statusu (po zalogowaniu poka≈ºe email/plan/status) */
    .status-bar {
      margin: 10px 0 6px 0;
      padding: 10px 12px;
      border: 1px solid #2a2e37;
      border-radius: 10px;
      background: #101421;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    .status-bar .left { display:flex; gap:10px; align-items:center; }
    .status-pill{
      padding: 4px 8px;
      border-radius: 999px;
      background: #1f2330;
      border: 1px solid #2a2e37;
      font-size: 12px;
      color: #e6e7ea;
    }

    /* Informacja o Stripe */
    .stripe-note {
      margin: 8px 0 10px 0;
      padding: 10px 12px;
      border: 1px solid #2a2e37;
      border-radius: 10px;
      background: #101421;
      font-size: 14px;
    }
    .stripe-note b { font-weight: 700; }

    /* Karta braku dostƒôpu dla niezalogowanych */
    .denied {
      text-align: center;
      padding: 28px;
      border: 1px dashed #2a2e37;
      background: linear-gradient(180deg,#121520,#0e1018);
    }
    .denied h3 { margin: 0 0 6px 0; }
    .cta-row { display:flex; gap:8px; justify-content:center; margin-top:12px; flex-wrap:wrap; }
    .cta-row a.button { background:#2b3242; }
    .cta-row a.button:hover { background:#3a4257; }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>üß† CIS Aurora ‚Äî AntyScam (Local)</h1>
    <p class="muted">Wklej adres kontraktu ETH, uruchom analizƒô i zobacz wynik. Serwer: Flask (port 5000).</p>

    <!-- üîê Pasek logowania Outseta -->
    <nav class="row">
      <a class="button" href="https://lucrum-media-company-spolka-z-ograniczona-odpowiedzialnoscia.outseta.com/auth?widgetMode=register#o-anonymous">Za≈Ç√≥≈º konto (trial 3 dni)</a>
      <a class="button" href="https://lucrum-media-company-spolka-z-ograniczona-odpowiedzialnoscia.outseta.com/auth?widgetMode=login#o-anonymous">Zaloguj</a>
      <a class="button" href="https://lucrum-media-company-spolka-z-ograniczona-odpowiedzialnoscia.outseta.com/profile#o-authenticated">Profil / P≈Çatno≈õci</a>
      <a class="button" href="#o-logout-link">Wyloguj</a>
    </nav>

    <!-- üßæ Pasek statusu u≈ºytkownika/subskrypcji (wype≈Çniany po zalogowaniu) -->
    <div id="statusBar" class="status-bar" style="display:none">
      <div class="left">
        <span id="statusUser" class="status-pill">‚Äî</span>
        <span id="statusPlan" class="status-pill">Plan: ‚Äî</span>
        <span id="statusState" class="status-pill">Status: ‚Äî</span>
      </div>
      <div class="right muted">P≈Çatno≈õci obs≈Çuguje <b>Stripe</b>.</div>
    </div>

    <!-- üîí Karta ‚Äûbrak dostƒôpu‚Äù (dla niezalogowanych) -->
    <div id="deniedCard" class="card denied" style="display:none">
      <h3>üîí Brak dostƒôpu do analizy</h3>
      <p class="muted">Ta funkcja jest dostƒôpna tylko dla zalogowanych u≈ºytkownik√≥w. Utw√≥rz konto i korzystaj z 3-dniowego triala.</p>
      <div class="cta-row">
        <a class="button" href="https://lucrum-media-company-spolka-z-ograniczona-odpowiedzialnoscia.outseta.com/auth?widgetMode=register#o-anonymous">Za≈Ç√≥≈º konto</a>
        <a class="button" href="https://lucrum-media-company-spolka-z-ograniczona-odpowiedzialnoscia.outseta.com/auth?widgetMode=login#o-anonymous">Zaloguj</a>
        <a class="button" href="https://lucrum-media-company-spolka-z-ograniczona-odpowiedzialnoscia.outseta.com/profile#o-authenticated">Profil / P≈Çatno≈õci</a>
      </div>
    </div>

    <!-- üß™ Karta analizy (pokazujemy tylko zalogowanym) -->
    <div id="analyzeCard" class="card" style="display:none">
      <form id="form">
        <label>Adres kontraktu (0x...):</label>
        <input id="address" type="text" placeholder="0x0000000000000000000000000000000000000000" />
        <div class="row">
          <button class="primary" type="submit">Analizuj</button>
        </div>
      </form>
    </div>

    <div id="resultCard" class="card" style="display:none">
      <h3>Wynik</h3>
      <div id="overlayHTML" class="card" style="border:none;padding:0;margin:0 0 8px 0"></div>
      <pre id="result" style="display:none;margin-top:12px">‚Äî</pre>
    </div>
  </div>

  <script>
    // UI refs
    const form        = document.getElementById("form");
    const resBox      = document.getElementById("result");
    const htmlBox     = document.getElementById("overlayHTML");
    const analyzeCard = document.getElementById("analyzeCard");
    const deniedCard  = document.getElementById("deniedCard");
    const resultCard  = document.getElementById("resultCard");

    const statusBar   = document.getElementById("statusBar");
    const statusUser  = document.getElementById("statusUser");
    const statusPlan  = document.getElementById("statusPlan");
    const statusState = document.getElementById("statusState");

    // Dodatkowe referencje
    const analyzeBtn  = document.querySelector("#analyzeCard button.primary");
    let paywallNote   = null;

    let isAuthed = false;
    let profile  = null;

    function setDisplay(el, show){
      if(!el) return;
      el.style.display = show ? "" : "none";
    }

    function renderStatus(p){
      if(!p){
        setDisplay(statusBar, false);
        statusUser.textContent  = "‚Äî";
        statusPlan.textContent  = "Plan: ‚Äî";
        statusState.textContent = "Status: ‚Äî";
        return;
      }
      setDisplay(statusBar, true);
      const email = p.Email || "‚Äî";
      // Spr√≥buj odczytaƒá plan i status z profilu (gdy sƒÖ subskrypcje)
      const subs = (p.Account && p.Account.Subscriptions) ? p.Account.Subscriptions : [];
      const first = subs && subs.length ? subs[0] : null;
      const planName = (first && first.Plan && first.Plan.Name) ? first.Plan.Name : "Trial / Brak planu";
      const state    = (first && (first.Status || first.State)) ? (first.Status || first.State) : "Brak aktywnej subskrypcji";

      statusUser.textContent  = email;
      statusPlan.textContent  = "Plan: " + planName;
      statusState.textContent = "Status: " + state;
    }

    // ‚úÖ tylko Active/Trial/Trialing majƒÖ dostƒôp do analizy
    function canAnalyze(p){
      const subs = (p?.Account?.Subscriptions) || [];
      const s = subs.length ? subs[0] : null;
      const status = (s?.Status || s?.State || "").toLowerCase();
      return ["active","trial","trialing"].includes(status);
    }

    function renderGate(){
      if(isAuthed){
        setDisplay(deniedCard, false);
        setDisplay(analyzeCard, true);
        setDisplay(resultCard, true);

        const allowed = canAnalyze(profile);

        if (analyzeBtn){
          analyzeBtn.disabled = !allowed;
          analyzeBtn.title = allowed ? "" : "Wymagana aktywna subskrypcja (lub trial).";
        }

        if (!paywallNote){
          paywallNote = document.createElement("div");
          paywallNote.style.cssText = "margin-top:10px;font-size:14px;padding:10px;border:1px solid #2a2e37;border-radius:8px;background:#101421;color:#9aa0a6;";
          analyzeCard.appendChild(paywallNote);
        }
        paywallNote.innerHTML = canAnalyze(profile)
          ? "‚úÖ Masz dostƒôp do analizy (plan aktywny lub trial)."
          : "üîí Dostƒôp zablokowany: aktywuj plan w <a href='https://lucrum-media-company-spolka-z-ograniczona-odpowiedzialnoscia.outseta.com/profile#o-authenticated' style='color:#cfd3ff'>Profil / P≈Çatno≈õci</a>.";

      }else{
        setDisplay(analyzeCard, false);
        setDisplay(resultCard, false);
        setDisplay(deniedCard, true);
      }
    }

    async function refreshAuthState(){
      try{
        // Szybki check: payload JWT (mo≈ºe byƒá null, gdy niezalogowany)
        const payload = await Outseta.getJwtPayload();
        isAuthed = !!payload;
        // Pe≈Çny profil (zawiera m.in. dane konta i subskrypcji)
        profile = isAuthed ? await Outseta.getUser() : null;
      }catch(_){
        isAuthed = false;
        profile = null;
      }
      renderStatus(profile);
      renderGate();
    }

    // Zdarzenia z Outsety ‚Äî reagujemy na login/logout/od≈õwie≈ºenie tokena
    Outseta.on('accessToken.set', refreshAuthState); // po zalogowaniu
    Outseta.on('logout', refreshAuthState);          // po wylogowaniu

    // Start: sprawd≈∫ stan autoryzacji
    refreshAuthState();

    // Obs≈Çuga formularza analizy (blok + nag≈Ç√≥wki do backendu)
    if(form){
      form.addEventListener("submit", async (e)=>{
        e.preventDefault();
        if(!isAuthed){
          // Dodatkowa ochrona UI
          setDisplay(deniedCard, true);
          return;
        }
        if(!canAnalyze(profile)){
          htmlBox.innerHTML = "<div style='padding:12px;color:#ffb4b4'>üîí Wymagana aktywna subskrypcja lub trial. Aktywuj plan w Profil / P≈Çatno≈õci.</div>";
          return;
        }

        htmlBox.innerHTML = "<div style='padding:12px;color:#9aa0a6'>‚è≥ Analiza w toku‚Ä¶</div>";
        const addr = document.getElementById("address").value.trim();

        // Token i email do weryfikacji serwerowej
        let token = "";
        try { token = await Outseta.getAccessToken(); } catch(_){}
        const email = (profile && profile.Email) ? profile.Email : "";

        const resp = await fetch("/analyze", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "Authorization": (token ? ("Bearer " + token) : ""),
            "X-User-Email": email
          },
          body: new URLSearchParams({ address: addr })
        });

        try{
          const data = await resp.json();
          if(resBox){
            let txt = data.error
              ? ("‚ùå " + (data.message || data.error))
              : `Status: ${data.status}\nCzas: ${data.elapsed_sec}s\nAdres: ${data.address}\nCmd: ${data.cmd}\n\nSTDOUT (tail):\n${data.stdout_tail || ""}\n\nSTDERR (tail):\n${data.stderr_tail || ""}`;
            if(data.last_report) txt += `\n\nOstatni raport: ${data.last_report}`;
            resBox.textContent = txt;
            resBox.style.display = "block";
          }
        }catch(_){
          // Ignoruj JSON parse error i po prostu poka≈º HTML warstwy
        }

        // Po wywo≈Çaniu analizy popro≈õ o HTML raportu (≈Çadna warstwa)
        try{
          const r = await fetch("/last-report-html");
          const txt = await r.text();
          htmlBox.innerHTML = (r.ok ? txt : `<pre>${txt}</pre>`);
        }catch(e){
          htmlBox.innerHTML = `<pre>${String(e)}</pre>`;
        }
      });
    }
  </script>
</body>
</html>
