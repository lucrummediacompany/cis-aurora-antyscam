<!DOCTYPE html>
<html lang="pl">
<head>
  <script>
    var o_options = {
      domain: 'lucrum-media-company-spolka-z-ograniczona-odpowiedzialnoscia.outseta.com',
      load: 'auth,customForm,emailList,leadCapture,nocode,profile,support'
    };
  </script>
  <script src="https://cdn.outseta.com/outseta.min.js" data-options="o_options"></script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CIS Aurora ‚Äî AntyScam</title>

  <style>
    :root { color-scheme: dark; }
    body { font-family: Arial, sans-serif; margin: 32px; background: #0e0f13; color: #e6e7ea; }
    .wrap { max-width: 900px; margin: auto; }
    h1 { margin-bottom: 6px; font-size: 28px; display:flex; align-items:center; gap:10px; }
    h1 span.logo-brain{ font-size:30px; }
    h1 span.title-text{
      background: linear-gradient(90deg,#f5c86a,#ff7fd1);
      -webkit-background-clip:text;
      background-clip:text;
      color: transparent;
      font-weight: 700;
    }
    .tagline { margin-top: 2px; }
    .card { border: 1px solid #2a2e37; border-radius: 12px; padding: 16px; margin-top: 16px; background: #141720; box-shadow: 0 2px 10px rgba(0,0,0,.4); }
    input[type=text]{ width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #2a2e37; background: #0f1220; color: #e6e7ea; }
    button { padding: 10px 16px; border-radius: 8px; border: none; cursor: pointer; transition: all .2s ease-in-out; }
    button.primary { background: #1f2330; color: #e6e7ea; }
    button.primary:hover { background: #2b3242; }
    pre { white-space: pre-wrap; background: #0f1220; padding: 12px; border-radius: 8px; max-height: 480px; overflow: auto; color: #e6e7ea; }
    .muted { color: #9aa0a6; font-size: 14px; }
    .row { display: flex; gap: 8px; margin-top: 8px; flex-wrap:wrap; }
    nav.row { margin-bottom: 12px; }
    nav.row a.button{ text-decoration: none; background: #1f2330; color: #e6e7ea; padding: 8px 14px; border-radius: 8px; transition: background .2s; }
    nav.row a.button:hover { background: #2b3242; }
    .status-bar { margin: 10px 0 6px 0; padding: 10px 12px; border: 1px solid #2a2e37; border-radius: 10px; background: #101421; font-size: 14px; display: flex; align-items: center; justify-content: space-between; gap: 12px; flex-wrap: wrap; }
    .status-bar .left { display:flex; gap:10px; align-items:center; }
    .status-pill{ padding: 4px 8px; border-radius: 999px; background: #1f2330; border: 1px solid #2a2e37; font-size: 12px; color: #e6e7ea; }

    .brand-bar{
      margin: 4px 0 10px 0;
      padding: 10px 12px;
      border-radius: 10px;
      background: linear-gradient(90deg,#151826,#101421);
      border: 1px solid #252a38;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      font-size:13px;
    }
    .brand-bar .label{ color:#9aa0a6; }
    .brand-badges{ display:flex; gap:8px; flex-wrap:wrap; }
    .brand-badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid #303549;
      background:#181b29;
      text-decoration:none;
      color:#e6e7ea;
      font-size:13px;
    }
    .brand-badge:hover{ background:#23283a; }
    .brand-icon{
      display:inline-block;
      width:16px;
      height:16px;
    }
    .brand-icon.outseta{
      border-radius:999px;
      border:2px solid #f5c86a;
      box-shadow:inset 0 0 0 2px #181b29;
    }
    .brand-icon.stripe{
      border-radius:4px;
      background:linear-gradient(135deg,#635bff,#7a5cff);
    }

    .denied { text-align: center; padding: 28px; border: 1px dashed #2a2e37; background: linear-gradient(180deg,#121520,#0e1018); }
    .denied h3 { margin: 0 0 6px 0; }
    .cta-row { display:flex; gap:8px; justify-content:center; margin-top:12px; flex-wrap:wrap; }
    .cta-row a.button { background:#2b3242; }
    .cta-row a.button:hover { background:#3a4257; }

    .footer{
      margin-top:26px;
      text-align:center;
      font-size:13px;
      color:#6f7684;
    }
    .footer a{
      color:#b1b7ff;
      text-decoration:none;
    }
    .footer a:hover{
      text-decoration:underline;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>
      <span class="logo-brain">üß†</span>
      <span class="title-text">CIS Aurora ‚Äî AntyScam</span>
    </h1>
    <p class="muted tagline">
      Wklej adres kontraktu ETH, uruchom analizƒô i zobacz ocenƒô ryzyka w kilka sekund. 
      Inteligentna tarcza anty-scam dla trader√≥w i projekt√≥w Web3.
    </p>

    <nav class="row">
      <a class="button" href="https://lucrum-media-company-spolka-z-ograniczona-odpowiedzialnoscia.outseta.com/auth?widgetMode=register#o-anonymous">Za≈Ç√≥≈º konto (trial 3 dni)</a>
      <a class="button" href="https://lucrum-media-company-spolka-z-ograniczona-odpowiedzialnoscia.outseta.com/auth?widgetMode=login#o-anonymous">Zaloguj</a>
      <a class="button" href="https://lucrum-media-company-spolka-z-ograniczona-odpowiedzialnoscia.outseta.com/profile#o-authenticated">Profil / P≈Çatno≈õci</a>
      <a class="button" href="https://www.lucrummediacompany.eu/" target="_blank" rel="noopener">O nas</a>
      <a class="button" href="#o-logout-link">Wyloguj</a>
    </nav>

    <div id="statusBar" class="status-bar" style="display:none">
      <div class="left">
        <span id="statusUser" class="status-pill">‚Äî</span>
        <span id="statusPlan" class="status-pill">Plan: ‚Äî</span>
        <span id="statusState" class="status-pill">Status: ‚Äî</span>
      </div>
      <div class="right muted">Infrastruktura subskrypcji: <b>Outseta</b> + <b>Stripe</b>.</div>
    </div>

    <div class="brand-bar">
      <div class="label">CIS Aurora ‚Äî AntyScam wsp√≥≈Çpracuje z:</div>
      <div class="brand-badges">
        <a href="https://www.outseta.com/" target="_blank" rel="noopener" class="brand-badge">
          <img src="static/outseta-logo-dark.svg" alt="Outseta" style="height:18px; display:block;">
        </a>
        <a href="https://stripe.com/" target="_blank" rel="noopener" class="brand-badge">
          <img src="static/stripe-logo-light.svg" alt="Stripe" style="height:18px; display:block;">
        </a>
      </div>
    </div>

    <div id="deniedCard" class="card denied" style="display:none">
      <h3>üîí Brak dostƒôpu do analizy</h3>
      <p class="muted">Ta funkcja jest dostƒôpna tylko dla zalogowanych u≈ºytkownik√≥w. Utw√≥rz konto i korzystaj z 3-dniowego triala.</p>
      <div class="cta-row">
        <a class="button" href="https://lucrum-media-company-spolka-z-ograniczona-odpowiedzialnoscia.outseta.com/auth?widgetMode=register#o-anonymous">Za≈Ç√≥≈º konto</a>
        <a class="button" href="https://lucrum-media-company-spolka-z-ograniczona-odpowiedzialnoscia.outseta.com/auth?widgetMode=login#o-anonymous">Zaloguj</a>
        <a class="button" href="https://lucrum-media-company-spolka-z-ograniczona-odpowiedzialnoscia.outseta.com/profile#o-authenticated">Profil / P≈Çatno≈õci</a>
      </div>
    </div>

    <div id="analyzeCard" class="card" style="display:none">
      <form id="form">
        <label>Adres kontraktu (0x...):</label>
        <input id="address" type="text" placeholder="0x0000000000000000000000000000000000000000" />
        <div class="row">
          <button class="primary" type="submit">Analizuj</button>
        </div>
      </form>
    </div>

    <div id="resultCard" class="card" style="display:none">
      <h3>Wynik</h3>
      <!-- Tylko raport HTML -->
      <div id="overlayHTML" class="card" style="border:none;padding:0;margin:0"></div>
      <!-- Konsola (wy≈ÇƒÖczona): zostawiamy w DOM, ale nie pokazujemy -->
      <pre id="result" style="display:none;margin-top:12px">‚Äî</pre>
    </div>

    <div class="footer muted">
      CIS Aurora ‚Äî AntyScam &nbsp;|&nbsp; projekt i rozw√≥j:&nbsp;
      <a href="https://www.lucrummediacompany.eu/" target="_blank" rel="noopener">Lucrum Media Company</a>
    </div>
  </div>

  <script>
    const DEBUG_TAIL = false; // ‚õîÔ∏è wy≈ÇƒÖczamy konsolƒô pod wynikiem

    const form        = document.getElementById("form");
    const resBox      = document.getElementById("result");
    const htmlBox     = document.getElementById("overlayHTML");
    const analyzeCard = document.getElementById("analyzeCard");
    const deniedCard  = document.getElementById("deniedCard");
    const resultCard  = document.getElementById("resultCard");
    const statusBar   = document.getElementById("statusBar");
    const statusUser  = document.getElementById("statusUser");
    const statusPlan  = document.getElementById("statusPlan");
    const statusState = document.getElementById("statusState");
    const analyzeBtn  = document.querySelector("#analyzeCard button.primary");

    let isAuthed = false;
    let profile  = null;

    function setDisplay(el, show){ if(el) el.style.display = show ? "" : "none"; }
    function fmtDate(d){ try { return d.toISOString().slice(0,10); } catch(_) { return ""; } }
    function getLower(x){ return (x===undefined||x===null) ? "" : String(x).toLowerCase(); }

    function renderStatus(p){
      if(!p){ setDisplay(statusBar,false); return; }
      setDisplay(statusBar,true);

      const email = p.Email || "‚Äî";
      const acc   = p.Account || {};
      const subs  = Array.isArray(acc.Subscriptions) ? acc.Subscriptions : [];
      const s     = subs.length ? subs[0] : null;

      let planName =
        (s && s.Plan && s.Plan.Name) ||
        (acc.CurrentSubscription && acc.CurrentSubscription.Plan && acc.CurrentSubscription.Plan.Name) ||
        (acc.Plan && acc.Plan.Name) || "";

      let stageCode = acc.AccountStage;
      try { stageCode = parseInt(stageCode,10); } catch(_) { stageCode = NaN; }
      const stageName = String(acc.AccountStageName || acc.StageName || acc.AccountStage || "").toLowerCase();

      const trialEndsRaw = acc.TrialEndsAt || acc.TrialEndDate || acc.TrialEndsOn || null;
      const trialIsActive = (() => {
        if(!trialEndsRaw) return false;
        const end = new Date(trialEndsRaw);
        return !isNaN(end.getTime()) && end.getTime() > Date.now();
      })();

      // Je≈õli nie mamy nazwy planu, ale Outseta m√≥wi "trial" ‚Üí ustaw "Trial"
      if(!planName && (stageCode === 2 || stageName.includes("trial") || trialIsActive)){
        planName = "Trial";
      }
      if(!planName) planName = "Brak planu";

      // U≈ºywamy tej samej logiki co gate, ≈ºeby status by≈Ç sp√≥jny z dostƒôpem
      const allowed = canAnalyze(p);
      let stateLabel;

      if(allowed){
        if(trialIsActive){
          stateLabel = trialEndsRaw
            ? ("Trial aktywny do " + fmtDate(new Date(trialEndsRaw)))
            : "Trial aktywny";
        }else{
          stateLabel = "Subskrypcja aktywna";
        }
      }else{
        stateLabel = "Brak aktywnej subskrypcji";
      }

      statusUser.textContent  = email;
      statusPlan.textContent  = "Plan: " + planName;
      statusState.textContent = "Status: " + stateLabel;
    }

    function canAnalyze(p){
      if(!p || !p.Account) return false;

      const acc  = p.Account || {};
      const subs = Array.isArray(acc.Subscriptions) ? acc.Subscriptions : [];
      const s    = subs.length ? subs[0] : null;
      const subStatus = getLower(s && (s.Status || s.State));

      let stageCode = acc.AccountStage;
      try { stageCode = parseInt(stageCode, 10); } catch(_) { stageCode = NaN; }
      if(stageCode === 2 || stageCode === 3) return true;

      if(["active","trial","trialing"].includes(subStatus)) return true;

      const accStageName = String(
        acc.AccountStageName || acc.StageName || acc.AccountStage || acc.Stage || ""
      ).toLowerCase();
      if(accStageName.includes("trial")) return true;

      const trialEndsRaw = acc.TrialEnd || acc.TrialEndsAt || acc.TrialEndDate || acc.TrialEndsOn;
      if(trialEndsRaw){
        const dt = new Date(trialEndsRaw);
        if(!isNaN(dt.getTime()) && dt.getTime() > Date.now()){
          return true;
        }
      }
      return false;
    }

    function renderGate(){
      if(isAuthed){
        setDisplay(deniedCard,false);
        setDisplay(analyzeCard,true);
        setDisplay(resultCard,true);

        const allowed = canAnalyze(profile);
        if (analyzeBtn){
          analyzeBtn.disabled = !allowed;
          analyzeBtn.title = allowed ? "" : "Wymagana aktywna subskrypcja lub aktywny trial.";
        }

        let note = document.getElementById("paywallNote");
        if(!note){
          note = document.createElement("div");
          note.id = "paywallNote";
          note.style.cssText = "margin-top:10px;font-size:14px;padding:10px;border:1px solid #2a2e37;border-radius:8px;background:#101421;color:#9aa0a6;";
          analyzeCard.appendChild(note);
        }
        note.textContent = allowed
          ? "‚úÖ Masz dostƒôp do analizy (plan aktywny lub trial)."
          : "üîí Dostƒôp zablokowany: aktywuj plan. Kliknij przycisk ‚ÄûProfil / P≈Çatno≈õci‚Äù powy≈ºej.";
      }else{
        setDisplay(analyzeCard,false);
        setDisplay(resultCard,false);
        setDisplay(deniedCard,true);
      }
    }

    async function refreshAuthState(){
      try{
        const payload = await Outseta.getJwtPayload();
        isAuthed = !!payload;
        profile = isAuthed ? await Outseta.getUser() : null;
      }catch(_){ isAuthed=false; profile=null; }
      renderStatus(profile);
      renderGate();
    }

    Outseta.on('accessToken.set', refreshAuthState);
    Outseta.on('logout', refreshAuthState);
    refreshAuthState();

    if(form){
      form.addEventListener("submit", async (e)=>{
        e.preventDefault();
        if(!isAuthed){ setDisplay(deniedCard,true); return; }
        if(!canAnalyze(profile)){
          htmlBox.textContent = "üîí Wymagana aktywna subskrypcja lub trial. U≈ºyj przycisku ‚ÄûProfil / P≈Çatno≈õci‚Äù.";
          return;
        }

        htmlBox.innerHTML = "<div style='padding:12px;color:#9aa0a6'>‚è≥ Analiza w toku‚Ä¶</div>";
        const addr = document.getElementById("address").value.trim();

        let token = "";
        try { token = await Outseta.getAccessToken(); } catch(_){}
        const email = (profile && profile.Email) ? profile.Email : "";

        const resp = await fetch("/analyze", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "Authorization": (token ? ("Bearer " + token) : ""),
            "X-User-Email": email
          },
          body: new URLSearchParams({ address: addr })
        });

        // Konsola pod wynikiem ‚Äî ca≈Çkowicie wy≈ÇƒÖczona gdy DEBUG_TAIL=false
        if (DEBUG_TAIL) {
          try{
            const data = await resp.json();
            if(resBox){
              let txt = data.error
                ? ("‚ùå " + (data.message || data.error))
                : `Status: ${data.status}\nCzas: ${data.elapsed_sec}s\nAdres: ${data.address}\nCmd: ${data.cmd}\n\nSTDOUT (tail):\n${data.stdout_tail || ""}\n\nSTDERR (tail):\n${data.stderr_tail || ""}`;
              if(data.last_report) txt += `\n\nOstatni raport: ${data.last_report}`;
              resBox.textContent = txt;
              resBox.style.display = "block";
            }
          }catch(_){}
        }

        // Zawsze ≈Çadujemy tylko finalny raport HTML
        try{
          const r = await fetch("/last-report-html");
          const txt = await r.text();
          htmlBox.innerHTML = (r.ok ? txt : `<pre>${txt}</pre>`);
        }catch(e){
          htmlBox.innerHTML = `<pre>${String(e)}</pre>`;
        }
      });
    }
  </script>
</body>
</html>
